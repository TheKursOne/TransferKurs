<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìÅ Share+QR ¬∑ Chunked ¬∑ Mobile</title>
    <!-- html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode" minified></script>
    <style>
        /* Gaya sama seperti sebelumnya ‚Äì minimalis, responsif */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf1f7 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }
        .container {
            max-width: 1100px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h1 { font-size: 28px; font-weight: 700; color: #0b2b4a; margin-bottom: 8px; }
        .sub {
            color: #3e5e7e; margin-bottom: 24px; font-size: 15px;
            border-left: 5px solid #2e7eb0; padding-left: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-scan {
            background: #0b2b4a; color: white; border: none; padding: 10px 20px;
            border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .upload-card {
            background: white; border-radius: 24px; padding: 24px;
            border: 1px solid rgba(0,0,0,0.04); margin-bottom: 24px;
        }
        .area-upload {
            display: flex; flex-wrap: wrap; align-items: center; gap: 16px;
        }
        .btn {
            background: white; border: 1.5px solid #d4e0e9; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; font-size: 15px; color: #1e3a5f;
            display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .btn-primary {
            background: #0b2b4a; border: none; color: white;
            box-shadow: 0 8px 18px rgba(11,43,74,0.2);
        }
        .expiry-selector {
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-left: auto;
        }
        select, input[type="number"] {
            padding: 10px 18px; border-radius: 40px; border: 1.5px solid #d4e0e9;
            font-size: 14px; background: white;
        }
        .file-list {
            background: white; border-radius: 24px; padding: 20px;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .file-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: #fafdff; border-radius: 20px; margin-bottom: 12px;
            border-left: 6px solid #2e7eb0; flex-wrap: wrap; gap: 12px;
        }
        .file-info { flex: 2; min-width: 200px; }
        .file-name { font-weight: 700; color: #0a1c2e; word-break: break-word; }
        .file-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; }
        .countdown {
            font-weight: 700; color: #b4511b; background: #ffeed9;
            padding: 4px 14px; border-radius: 40px; font-size: 13px;
        }
        .btn-sm {
            padding: 8px 16px; font-size: 13px; border-radius: 40px;
            border: 1px solid #cbd6e0; background: white; font-weight: 600; cursor: pointer;
        }
        .btn-delete { color: #b33a3a; border-color: #f3cdcd; }
        .progress-bar {
            width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; margin-top: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #2e7eb0; width: 0%; transition: width 0.2s;
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 28px; border-radius: 32px; max-width: 400px; width: 90%;
            text-align: center;
        }
        .qr-image { width: 200px; height: 200px; margin: 20px auto; border: 2px solid #e2e8f0; padding: 10px; border-radius: 20px; background: white; }
        .qr-image img { width: 100%; height: 100%; object-fit: contain; }
        #qr-scanner-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #reader { width: 100%; max-width: 450px; background: black; border-radius: 24px; overflow: hidden; }
        .close-scanner {
            margin-top: 20px; background: white; border: none; padding: 12px 30px;
            border-radius: 50px; font-weight: 600; cursor: pointer;
        }
        .warning {
            background: #fff3cd; color: #856404; padding: 12px; border-radius: 12px;
            margin: 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .footer { margin-top: 32px; text-align: center; color: #4e6a7c; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÅ Share+QR ¬∑ Chunked</h1>
        <div class="sub">
            <span>üîí File disimpan di browser ini. Link berlaku di perangkat yang sama.<br>‚è∞ Expired otomatis. üì± Khusus HP: file besar di-chunk 1MB.</span>
            <button id="scanQrBtn" class="btn-scan">üì∑ Scan QR</button>
        </div>

        <!-- UPLOAD CARD -->
        <div class="upload-card">
            <div class="area-upload">
                <label for="fileInput" class="btn btn-primary">
                    üìÅ Pilih File
                </label>
                <input type="file" id="fileInput" multiple hidden>

                <div class="expiry-selector">
                    <label>‚è±Ô∏è Expired:</label>
                    <select id="expirySelect">
                        <option value="5">5 menit</option>
                        <option value="30">30 menit</option>
                        <option value="60">1 jam</option>
                        <option value="360">6 jam</option>
                        <option value="1440">1 hari</option>
                        <option value="10080">7 hari</option>
                        <option value="0">Custom</option>
                    </select>
                    <input type="number" id="customExpiry" placeholder="detik" min="1" style="width:90px; display:none;">
                </div>
            </div>
            <div id="uploadProgress" style="margin-top: 16px; display: none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span id="uploadStatus">‚è≥ Mengupload...</span>
                    <span id="uploadPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="uploadProgressFill" class="progress-fill" style="width:0%"></div>
                </div>
            </div>
            <div id="uploadMessage" style="margin-top: 16px; color: #2e7eb0;"></div>
        </div>

        <!-- DAFTAR FILE -->
        <div class="file-list">
            <div class="file-header">
                <h3>üìã File tersimpan</h3>
                <span id="totalSize" style="background:#e9f2f9; padding:6px 16px; border-radius:30px;">0 B</span>
            </div>
            <div id="fileListContainer">
                <div class="empty-message" style="text-align:center; padding:40px; color:#657e94;">
                    ‚ö° Belum ada file. Upload sekarang!
                </div>
            </div>
        </div>
        <div class="footer">‚ö° OXYX ¬∑ CHUNKED 1MB ¬∑ EXPIRED OTOMATIS ¬∑ QR</div>
    </div>

    <!-- MODAL QR -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h3>üîó QR Code Link</h3>
            <div id="qrImageContainer" class="qr-image"></div>
            <p id="qrFileName" style="font-weight:600;"></p>
            <button id="closeQrModal" class="close-scanner" style="margin-top:12px;">Tutup</button>
        </div>
    </div>

    <!-- SCANNER QR -->
    <div id="qr-scanner-container">
        <div id="reader"></div>
        <button id="closeScanner" class="close-scanner">Tutup Scanner</button>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== INDEXEDDB DENGAN CHUNKING ==========
            const DB_NAME = 'ExpireFileChunked';
            const DB_VERSION = 2;        // upgrade karena schema baru
            const STORE_FILES = 'files';     // metadata
            const STORE_CHUNKS = 'chunks';   // chunk data

            let db = null;

            function openDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        db = request.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        // store untuk metadata file
                        if (!db.objectStoreNames.contains(STORE_FILES)) {
                            const fileStore = db.createObjectStore(STORE_FILES, { keyPath: 'id' });
                            fileStore.createIndex('expiresAt', 'expiresAt', { unique: false });
                        }
                        // store untuk chunk
                        if (!db.objectStoreNames.contains(STORE_CHUNKS)) {
                            db.createObjectStore(STORE_CHUNKS, { keyPath: 'chunkId' });
                        }
                    };
                });
            }

            // Simpan file dengan chunking
            async function saveFileChunked(file, expiresInSeconds) {
                await openDB();
                const fileId = Date.now() + '-' + Math.random().toString(36).substring(2) + '-' + file.name;
                const expiresAt = Date.now() + (expiresInSeconds * 1000);
                const chunkSize = 1024 * 1024; // 1MB per chunk
                const totalChunks = Math.ceil(file.size / chunkSize);
                let chunksSaved = 0;

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_FILES, STORE_CHUNKS], 'readwrite');
                    const fileStore = transaction.objectStore(STORE_FILES);
                    const chunkStore = transaction.objectStore(STORE_CHUNKS);

                    // Simpan metadata
                    const fileMetadata = {
                        id: fileId,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        totalChunks: totalChunks,
                        chunkSize: chunkSize,
                        expiresAt: expiresAt,
                        uploadedAt: Date.now()
                    };
                    fileStore.put(fileMetadata);

                    // Baca file dan simpan chunk
                    const reader = new FileReader();
                    let offset = 0;
                    let chunkIndex = 0;

                    reader.onload = function(e) {
                        const arrayBuffer = e.target.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        const chunkId = `${fileId}-chunk-${chunkIndex}`;
                        chunkStore.put({
                            chunkId: chunkId,
                            fileId: fileId,
                            index: chunkIndex,
                            data: uint8Array
                        });

                        chunksSaved++;
                        offset += chunkSize;
                        chunkIndex++;

                        if (offset < file.size) {
                            readNextChunk();
                        } else {
                            // update progress via transaction complete
                        }

                        // Update progress (dikirim ke luar)
                        if (window.onUploadProgress) {
                            window.onUploadProgress({
                                percent: Math.round((chunksSaved / totalChunks) * 100),
                                chunksSaved,
                                totalChunks
                            });
                        }
                    };

                    reader.onerror = function(err) {
                        reject(err);
                    };

                    function readNextChunk() {
                        const slice = file.slice(offset, offset + chunkSize);
                        reader.readAsArrayBuffer(slice);
                    }

                    readNextChunk();

                    transaction.oncomplete = () => {
                        resolve(fileId);
                    };
                    transaction.onerror = (e) => reject(e.target.error);
                });
            }

            // Ambil file (gabung chunk)
            async function getFileChunked(fileId) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_FILES, STORE_CHUNKS], 'readonly');
                    const fileStore = transaction.objectStore(STORE_FILES);
                    const chunkStore = transaction.objectStore(STORE_CHUNKS);

                    const fileReq = fileStore.get(fileId);
                    fileReq.onsuccess = async function(e) {
                        const metadata = e.target.result;
                        if (!metadata) {
                            resolve(null);
                            return;
                        }

                        const totalChunks = metadata.totalChunks;
                        const chunks = [];

                        for (let i = 0; i < totalChunks; i++) {
                            const chunkId = `${fileId}-chunk-${i}`;
                            const chunkReq = chunkStore.get(chunkId);
                            await new Promise((res) => { chunkReq.onsuccess = res; });
                            if (chunkReq.result) {
                                chunks.push(chunkReq.result.data);
                            } else {
                                reject(new Error(`Chunk ${i} hilang`));
                                return;
                            }
                        }

                        // Gabung semua chunk jadi Blob
                        const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
                        const fullArray = new Uint8Array(totalLength);
                        let offset = 0;
                        for (let chunk of chunks) {
                            fullArray.set(chunk, offset);
                            offset += chunk.length;
                        }
                        const blob = new Blob([fullArray], { type: metadata.type });
                        resolve({
                            ...metadata,
                            blob: blob
                        });
                    };
                    fileReq.onerror = (e) => reject(e.target.error);
                });
            }

            // Hapus file + semua chunk-nya
            async function deleteFileChunked(fileId) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_FILES, STORE_CHUNKS], 'readwrite');
                    const fileStore = transaction.objectStore(STORE_FILES);
                    const chunkStore = transaction.objectStore(STORE_CHUNKS);

                    // Hapus metadata
                    fileStore.delete(fileId);

                    // Hapus semua chunk (pakai cursor)
                    const index = chunkStore.index('fileId'); // perlu bikin index? lebih simple: cursor semua dan filter
                    // Gak punya index, jadi kita pakai pendekatan: get all keys, cari yang startsWith
                    // Alternatif: saat upgrade, buat index. Tapi biar simple, kita lakukan di kode manual.
                    // Solusi: simpan dengan prefix, lalu hapus dengan range.
                    const range = IDBKeyRange.bound(
                        `${fileId}-chunk-`,
                        `${fileId}-chunk-\uffff`,
                        false, false
                    );
                    chunkStore.delete(range);
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => reject(e.target.error);
                });
            }

            // Ambil semua metadata file (tidak termasuk blob)
            async function getAllFilesMetadata() {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_FILES], 'readonly');
                    const store = transaction.objectStore(STORE_FILES);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // Hapus file expired
            async function deleteExpiredFiles() {
                const files = await getAllFilesMetadata();
                const now = Date.now();
                for (let f of files) {
                    if (f.expiresAt <= now) {
                        await deleteFileChunked(f.id);
                    }
                }
                return files.filter(f => f.expiresAt > now).length;
            }

            // ========== UI & GLOBAL ==========
            let refreshInterval = null;
            const fileInput = document.getElementById('fileInput');
            const expirySelect = document.getElementById('expirySelect');
            const customExpiry = document.getElementById('customExpiry');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadMessage = document.getElementById('uploadMessage');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressFill = document.getElementById('uploadProgressFill');
            const uploadPercent = document.getElementById('uploadPercent');
            const totalSizeSpan = document.getElementById('totalSize');
            const fileListContainer = document.getElementById('fileListContainer');

            // QR Modal
            const qrModal = document.getElementById('qrModal');
            const qrImageContainer = document.getElementById('qrImageContainer');
            const qrFileName = document.getElementById('qrFileName');
            const closeQrModal = document.getElementById('closeQrModal');

            // QR Scanner
            const scanQrBtn = document.getElementById('scanQrBtn');
            const scannerContainer = document.getElementById('qr-scanner-container');
            const closeScanner = document.getElementById('closeScanner');
            const readerElement = document.getElementById('reader');
            let html5QrCode = null;

            // ========== UTILS ==========
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
            }
            function escapeHtml(unsafe) {
                return unsafe.replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            // ========== RENDER FILE LIST ==========
            async function renderFileList() {
                const files = await getAllFilesMetadata();
                const now = Date.now();
                const validFiles = files.filter(f => f.expiresAt > now);
                // Hapus expired di background
                for (let f of files) {
                    if (f.expiresAt <= now) {
                        await deleteFileChunked(f.id);
                    }
                }

                const totalBytes = validFiles.reduce((acc, f) => acc + (f.size || 0), 0);
                totalSizeSpan.textContent = formatBytes(totalBytes);

                if (validFiles.length === 0) {
                    fileListContainer.innerHTML = `<div class="empty-message">üì≠ Tidak ada file. Upload sekarang!</div>`;
                    return;
                }

                validFiles.sort((a,b) => b.uploadedAt - a.uploadedAt);
                let html = '';
                validFiles.forEach(file => {
                    const expiresInMs = file.expiresAt - now;
                    const expiresInSec = Math.floor(expiresInMs / 1000);
                    const minutes = Math.floor(expiresInSec / 60);
                    const seconds = expiresInSec % 60;
                    let timeText = expiresInSec <= 0 ? '‚èπÔ∏è Expired' : 
                        (minutes > 0 ? `‚è≥ ${minutes}m ${seconds}d` : `‚è≥ ${seconds}d`);
                    
                    html += `
                        <div class="file-item" data-file-id="${escapeHtml(file.id)}">
                            <div class="file-info">
                                <div class="file-name">üìÑ ${escapeHtml(file.name)}</div>
                                <div class="file-meta">
                                    <span>${formatBytes(file.size)}</span>
                                    <span class="countdown">${timeText}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn-sm" onclick="window.copyLink('${escapeHtml(file.id)}')">üîó Link</button>
                                <button class="btn-sm" onclick="window.showQR('${escapeHtml(file.id)}', '${escapeHtml(file.name)}')">üì∑ QR</button>
                                <button class="btn-sm btn-delete" onclick="window.deleteFile('${escapeHtml(file.id)}')">‚úï</button>
                            </div>
                        </div>
                    `;
                });
                fileListContainer.innerHTML = html;
            }

            // ========== UPLOAD HANDLER ==========
            window.onUploadProgress = function(progress) {
                uploadPercent.textContent = `${progress.percent}%`;
                uploadProgressFill.style.width = `${progress.percent}%`;
                uploadStatus.textContent = `‚è≥ Upload ${progress.chunksSaved}/${progress.totalChunks} chunk`;
            };

            async function handleUpload(files) {
                if (!files.length) return;
                // Cek ukuran untuk HP
                if (files[0].size > 100 * 1024 * 1024) {
                    alert('‚ö†Ô∏è File >100MB mungkin lambat/crash di HP. Gunakan file lebih kecil atau di desktop.');
                }

                let expirySeconds = parseInt(expirySelect.value);
                if (expirySelect.value === '0') {
                    expirySeconds = parseInt(customExpiry.value);
                    if (isNaN(expirySeconds) || expirySeconds < 1) {
                        alert('Masukkan durasi expired (detik)');
                        return;
                    }
                }

                uploadProgress.style.display = 'block';
                uploadPercent.textContent = '0%';
                uploadProgressFill.style.width = '0%';
                uploadMessage.textContent = '';

                for (let i = 0; i < files.length; i++) {
                    try {
                        const fileId = await saveFileChunked(files[i], expirySeconds);
                        uploadMessage.textContent += `‚úÖ ${files[i].name} selesai. `;
                    } catch (err) {
                        console.error(err);
                        uploadMessage.textContent = `‚ùå Gagal upload ${files[i].name}: ${err.message}`;
                    }
                }

                uploadProgress.style.display = 'none';
                await renderFileList();
                fileInput.value = '';
            }

            // ========== GLOBAL FUNCTIONS ==========
            window.copyLink = function(fileId) {
                const url = new URL(window.location.href);
                url.hash = `#file-${fileId}`;
                navigator.clipboard.writeText(url.toString()).then(() => {
                    uploadMessage.textContent = '‚úÖ Link disalin!';
                    setTimeout(() => { uploadMessage.textContent = ''; }, 2000);
                }).catch(() => prompt('Salin manual:', url.toString()));
            };

            window.deleteFile = async function(fileId) {
                await deleteFileChunked(fileId);
                renderFileList();
                uploadMessage.textContent = 'üóëÔ∏è File dihapus';
                setTimeout(() => { uploadMessage.textContent = ''; }, 2000);
            };

            window.showQR = function(fileId, fileName) {
                const url = new URL(window.location.href);
                url.hash = `#file-${fileId}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url.toString())}`;
                qrImageContainer.innerHTML = `<img src="${qrUrl}" alt="QR">`;
                qrFileName.textContent = `üìÑ ${fileName}`;
                qrModal.style.display = 'flex';
            };

            // ========== DOWNLOAD VIA HASH ==========
            async function handleHash() {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#file-')) {
                    const fileId = hash.substring(6);
                    const fileData = await getFileChunked(fileId);
                    if (!fileData) {
                        alert('‚ùå File tidak ditemukan / expired.');
                        window.location.hash = '';
                        return;
                    }
                    if (fileData.expiresAt <= Date.now()) {
                        alert('‚èπÔ∏è File sudah expired.');
                        await deleteFileChunked(fileId);
                        window.location.hash = '';
                        return;
                    }
                    // Download
                    const blob = fileData.blob;
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    a.click();
                    URL.revokeObjectURL(url);
                    window.location.hash = '';
                }
            }

            // ========== SCAN QR ==========
            function startScanner() {
                scannerContainer.style.display = 'flex';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        html5QrCode.stop().then(() => {
                            scannerContainer.style.display = 'none';
                            try {
                                const url = new URL(decodedText);
                                if (url.hash && url.hash.startsWith('#file-')) {
                                    window.location.href = decodedText;
                                } else {
                                    alert('QR bukan link file valid.');
                                }
                            } catch(e) {
                                alert('QR tidak valid.');
                            }
                        });
                    },
                    (err) => {}
                ).catch(err => {
                    alert('Gagal akses kamera: ' + err);
                    scannerContainer.style.display = 'none';
                });
            }

            // ========== EVENT LISTENERS ==========
            fileInput.addEventListener('change', (e) => handleUpload(e.target.files));

            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length) await handleUpload(e.dataTransfer.files);
            });

            expirySelect.addEventListener('change', function() {
                customExpiry.style.display = this.value === '0' ? 'inline-block' : 'none';
            });

            closeQrModal.addEventListener('click', () => qrModal.style.display = 'none');
            window.addEventListener('click', (e) => {
                if (e.target === qrModal) qrModal.style.display = 'none';
                if (e.target === scannerContainer) {
                    if (html5QrCode) html5QrCode.stop();
                    scannerContainer.style.display = 'none';
                }
            });

            scanQrBtn.addEventListener('click', startScanner);
            closeScanner.addEventListener('click', () => {
                if (html5QrCode) html5QrCode.stop();
                scannerContainer.style.display = 'none';
            });

            // ========== INIT ==========
            window.onload = async function() {
                await openDB();
                await deleteExpiredFiles();
                await renderFileList();
                await handleHash();
                refreshInterval = setInterval(async () => {
                    await deleteExpiredFiles();
                    await renderFileList();
                }, 5000);
            };
            window.onbeforeunload = function() {
                if (refreshInterval) clearInterval(refreshInterval);
                if (html5QrCode) html5QrCode.stop();
            };
            window.addEventListener('hashchange', handleHash);
        })();
    </script>
</body>
</html>
